<template>
  <div id="zoomChart"></div>
</template>

<script>
import {postRequestJson} from "../../../../api/pattern/api";
import {mapMutations} from "vuex";
import {str2listForRain} from "../../../../api/pattern/dataUtils";

export default {
  name: "ZoomChart",
  data(){
    return{
      currentChartParam:{
        timestamp:[
          '2020-01-22 08:00:00', '2020-01-22 09:00:00', '2020-01-22 10:00:00', '2020-01-22 11:00:00', '2020-01-22 12:00:00', '2020-01-22 13:00:00', '2020-01-22 14:00:00', '2020-01-22 15:00:00', '2020-01-22 16:00:00', '2020-01-22 17:00:00', '2020-01-22 18:00:00', '2020-01-22 19:00:00', '2020-01-22 20:00:00', '2020-01-22 21:00:00', '2020-01-22 22:00:00', '2020-01-22 23:00:00', '2020-01-23 00:00:00', '2020-01-23 01:00:00', '2020-01-23 02:00:00', '2020-01-23 03:00:00', '2020-01-23 04:00:00', '2020-01-23 05:00:00', '2020-01-23 06:00:00', '2020-01-23 07:00:00', '2020-01-23 08:00:00', '2020-01-23 09:00:00', '2020-01-23 10:00:00', '2020-01-23 11:00:00', '2020-01-23 12:00:00', '2020-01-23 13:00:00', '2020-01-23 14:00:00', '2020-01-23 15:00:00', '2020-01-23 16:00:00', '2020-01-23 17:00:00', '2020-01-23 18:00:00', '2020-01-23 19:00:00', '2020-01-23 20:00:00', '2020-01-23 21:00:00', '2020-01-23 22:00:00', '2020-01-23 23:00:00', '2020-01-24 00:00:00', '2020-01-24 01:00:00', '2020-01-24 02:00:00', '2020-01-24 03:00:00', '2020-01-24 04:00:00', '2020-01-24 05:00:00', '2020-01-24 06:00:00', '2020-01-24 07:00:00', '2020-01-24 08:00:00', '2020-01-24 09:00:00', '2020-01-24 10:00:00', '2020-01-24 11:00:00', '2020-01-24 12:00:00', '2020-01-24 13:00:00', '2020-01-24 14:00:00', '2020-01-24 15:00:00', '2020-01-24 16:00:00', '2020-01-24 17:00:00', '2020-01-24 18:00:00', '2020-01-24 19:00:00', '2020-01-24 20:00:00', '2020-01-24 21:00:00', '2020-01-24 22:00:00', '2020-01-24 23:00:00', '2020-01-25 00:00:00', '2020-01-25 01:00:00', '2020-01-25 02:00:00', '2020-01-25 03:00:00', '2020-01-25 04:00:00', '2020-01-25 05:00:00', '2020-01-25 06:00:00', '2020-01-25 07:00:00', '2020-01-25 08:00:00', '2020-01-25 09:00:00', '2020-01-25 10:00:00', '2020-01-25 11:00:00', '2020-01-25 12:00:00', '2020-01-25 13:00:00', '2020-01-25 14:00:00', '2020-01-25 15:00:00', '2020-01-25 16:00:00', '2020-01-25 17:00:00', '2020-01-25 18:00:00', '2020-01-25 19:00:00', '2020-01-25 20:00:00', '2020-01-25 21:00:00', '2020-01-25 22:00:00', '2020-01-25 23:00:00', '2020-01-26 00:00:00', '2020-01-26 01:00:00', '2020-01-26 02:00:00', '2020-01-26 03:00:00', '2020-01-26 04:00:00', '2020-01-26 05:00:00', '2020-01-26 06:00:00', '2020-01-26 07:00:00', '2020-01-26 08:00:00', '2020-01-26 09:00:00', '2020-01-26 10:00:00', '2020-01-26 11:00:00', '2020-01-26 12:00:00', '2020-01-26 13:00:00', '2020-01-26 14:00:00', '2020-01-26 15:00:00', '2020-01-26 16:00:00', '2020-01-26 17:00:00', '2020-01-26 18:00:00', '2020-01-26 19:00:00', '2020-01-26 20:00:00', '2020-01-26 21:00:00', '2020-01-26 22:00:00', '2020-01-26 23:00:00', '2020-01-27 00:00:00', '2020-01-27 01:00:00', '2020-01-27 02:00:00', '2020-01-27 03:00:00', '2020-01-27 04:00:00', '2020-01-27 05:00:00', '2020-01-27 06:00:00', '2020-01-27 07:00:00', '2020-01-27 08:00:00', '2020-01-27 09:00:00', '2020-01-27 10:00:00', '2020-01-27 11:00:00', '2020-01-27 12:00:00', '2020-01-27 13:00:00', '2020-01-27 14:00:00', '2020-01-27 15:00:00', '2020-01-27 16:00:00', '2020-01-27 17:00:00', '2020-01-27 18:00:00', '2020-01-27 19:00:00', '2020-01-27 20:00:00', '2020-01-27 21:00:00', '2020-01-27 22:00:00', '2020-01-27 23:00:00', '2020-01-28 00:00:00', '2020-01-28 01:00:00', '2020-01-28 02:00:00', '2020-01-28 03:00:00', '2020-01-28 04:00:00', '2020-01-28 05:00:00', '2020-01-28 06:00:00', '2020-01-28 07:00:00', '2020-01-28 08:00:00', '2020-01-28 09:00:00', '2020-01-28 10:00:00', '2020-01-28 11:00:00', '2020-01-28 12:00:00', '2020-01-28 13:00:00', '2020-01-28 14:00:00', '2020-01-28 15:00:00', '2020-01-28 16:00:00', '2020-01-28 17:00:00', '2020-01-28 18:00:00', '2020-01-28 19:00:00', '2020-01-28 20:00:00', '2020-01-28 21:00:00', '2020-01-28 22:00:00', '2020-01-28 23:00:00', '2020-01-29 00:00:00', '2020-01-29 01:00:00', '2020-01-29 02:00:00', '2020-01-29 03:00:00', '2020-01-29 04:00:00', '2020-01-29 05:00:00', '2020-01-29 06:00:00', '2020-01-29 07:00:00', '2020-01-29 08:00:00', '2020-01-29 09:00:00', '2020-01-29 10:00:00', '2020-01-29 11:00:00', '2020-01-29 12:00:00', '2020-01-29 13:00:00', '2020-01-29 14:00:00', '2020-01-29 15:00:00', '2020-01-29 16:00:00', '2020-01-29 17:00:00', '2020-01-29 18:00:00', '2020-01-29 19:00:00', '2020-01-29 20:00:00', '2020-01-29 21:00:00', '2020-01-29 22:00:00', '2020-01-29 23:00:00', '2020-01-30 00:00:00', '2020-01-30 01:00:00', '2020-01-30 02:00:00', '2020-01-30 03:00:00', '2020-01-30 04:00:00', '2020-01-30 05:00:00', '2020-01-30 06:00:00', '2020-01-30 07:00:00', '2020-01-30 08:00:00', '2020-01-30 09:00:00', '2020-01-30 10:00:00', '2020-01-30 11:00:00', '2020-01-30 12:00:00', '2020-01-30 13:00:00', '2020-01-30 14:00:00', '2020-01-30 15:00:00', '2020-01-30 16:00:00', '2020-01-30 17:00:00', '2020-01-30 18:00:00', '2020-01-30 19:00:00', '2020-01-30 20:00:00', '2020-01-30 21:00:00', '2020-01-30 22:00:00', '2020-01-30 23:00:00', '2020-01-31 00:00:00', '2020-01-31 01:00:00', '2020-01-31 02:00:00', '2020-01-31 03:00:00', '2020-01-31 04:00:00', '2020-01-31 05:00:00', '2020-01-31 06:00:00', '2020-01-31 07:00:00', '2020-01-31 08:00:00', '2020-01-31 09:00:00', '2020-01-31 10:00:00', '2020-01-31 11:00:00', '2020-01-31 12:00:00', '2020-01-31 13:00:00', '2020-01-31 14:00:00', '2020-01-31 15:00:00', '2020-01-31 16:00:00', '2020-01-31 17:00:00', '2020-01-31 18:00:00', '2020-01-31 19:00:00', '2020-01-31 20:00:00', '2020-01-31 21:00:00', '2020-01-31 22:00:00', '2020-01-31 23:00:00', '2020-02-01 00:00:00', '2020-02-01 01:00:00', '2020-02-01 02:00:00', '2020-02-01 03:00:00', '2020-02-01 04:00:00', '2020-02-01 05:00:00', '2020-02-01 06:00:00', '2020-02-01 07:00:00', '2020-02-01 08:00:00', '2020-02-01 09:00:00', '2020-02-01 10:00:00', '2020-02-01 11:00:00', '2020-02-01 12:00:00', '2020-02-01 13:00:00', '2020-02-01 14:00:00', '2020-02-01 15:00:00', '2020-02-01 16:00:00', '2020-02-01 17:00:00', '2020-02-01 18:00:00', '2020-02-01 19:00:00', '2020-02-01 20:00:00', '2020-02-01 21:00:00', '2020-02-01 22:00:00', '2020-02-01 23:00:00', '2020-02-02 00:00:00', '2020-02-02 01:00:00', '2020-02-02 02:00:00', '2020-02-02 03:00:00', '2020-02-02 04:00:00', '2020-02-02 05:00:00', '2020-02-02 06:00:00', '2020-02-02 07:00:00', '2020-02-02 08:00:00', '2020-02-02 09:00:00', '2020-02-02 10:00:00', '2020-02-02 11:00:00', '2020-02-02 12:00:00', '2020-02-02 13:00:00', '2020-02-02 14:00:00', '2020-02-02 15:00:00', '2020-02-02 16:00:00', '2020-02-02 17:00:00', '2020-02-02 18:00:00', '2020-02-02 19:00:00', '2020-02-02 20:00:00', '2020-02-02 21:00:00', '2020-02-02 22:00:00', '2020-02-02 23:00:00', '2020-02-03 00:00:00', '2020-02-03 01:00:00', '2020-02-03 02:00:00', '2020-02-03 03:00:00', '2020-02-03 04:00:00', '2020-02-03 05:00:00', '2020-02-03 06:00:00', '2020-02-03 07:00:00', '2020-02-03 08:00:00', '2020-02-03 09:00:00', '2020-02-03 10:00:00', '2020-02-03 11:00:00', '2020-02-03 12:00:00', '2020-02-03 13:00:00', '2020-02-03 14:00:00', '2020-02-03 15:00:00'
        ],
        flow:[
          20.5, 27.48, 34.46, 41.44, 48.42, 55.4, 62.38, 69.35, 76.33, 83.31, 90.29, 97.27, 104.25, 111.23, 118.21, 125.19, 132.17, 139.15, 146.13, 153.1, 160.08, 167.06, 174.04, 181.02, 188.0, 193.56, 200.02, 210.12, 220.23, 230.33, 240.43, 252.41, 267.85, 283.3, 298.75, 314.19, 329.64, 345.09, 360.53, 375.98, 391.43, 406.87, 422.32, 437.77, 453.21, 468.66, 484.11, 499.55, 515.0, 504.53, 493.47, 481.95, 470.43, 458.91, 447.39, 435.86, 424.34, 412.82, 401.3, 389.78, 378.26, 366.74, 355.21, 343.69, 332.17, 320.65, 309.13, 297.61, 286.09, 274.56, 263.04, 251.52, 240.0, 237.43, 236.65, 236.22, 238.13, 242.53, 246.94, 251.34, 252.05, 252.11, 252.17, 252.23, 252.29, 252.35, 252.41, 252.47, 252.53, 252.58, 252.64, 252.7, 252.76, 252.82, 252.88, 252.94, 253.0, 253.29, 253.58, 253.88, 254.17, 254.46, 254.75, 255.04, 255.33, 255.63, 255.92, 256.21, 256.5, 256.79, 257.08, 257.38, 257.67, 257.96, 258.25, 258.54, 258.83, 259.13, 259.42, 259.71, 260.0, 255.92, 251.83, 247.75, 243.67, 239.58, 235.5, 231.42, 227.33, 223.25, 219.17, 215.08, 211.0, 206.92, 202.83, 198.75, 194.67, 190.58, 186.5, 182.42, 178.33, 174.25, 170.17, 166.08, 162.0, 155.33, 150.82, 148.47, 146.11, 143.76, 141.4, 139.04, 136.69, 134.33, 131.98, 129.62, 127.27, 124.91, 122.56, 120.2, 117.84, 115.49, 113.13, 110.78, 108.42, 106.07, 103.71, 101.36, 99.0, 97.88, 96.75, 95.63, 94.5, 93.38, 92.25, 91.13, 90.0, 88.88, 87.75, 86.63, 85.5, 84.38, 83.25, 82.13, 81.0, 79.88, 78.75, 77.63, 76.5, 75.38, 74.25, 73.13, 72.0, 71.5, 71.0, 70.5, 70.0, 69.5, 69.0, 68.5, 68.0, 67.5, 67.0, 66.5, 66.0, 65.5, 65.0, 64.5, 64.0, 63.5, 63.0, 62.5, 62.0, 61.5, 61.0, 60.5, 60.0, 58.88, 57.75, 56.63, 55.5, 54.38, 53.25, 52.13, 51.0, 49.88, 48.75, 47.63, 46.5, 45.38, 44.25, 43.13, 42.0, 40.88, 39.75, 38.63, 37.5, 36.38, 35.25, 34.13, 33.0, 32.81, 32.63, 32.44, 32.25, 32.06, 31.88, 31.69, 31.5, 31.31, 31.13, 30.94, 30.75, 30.56, 30.38, 30.19, 30.0, 29.81, 29.63, 29.44, 29.25, 29.06, 28.88, 28.69, 28.5, 28.19, 27.88, 27.56, 27.25, 26.94, 26.63, 26.31, 26.0, 25.69, 25.38, 25.06, 24.75, 24.44, 24.13, 23.81, 23.5, 23.19, 22.88, 22.56, 22.25, 21.94, 21.63, 21.31, 21.0, 22.61, 24.22, 25.83, 27.44, 28.1, 27.67, 27.25
        ],
        rain:[
          11.7538, 13.4416, 13.5592, 14.8434, 13.7507, 16.6416, 14.7373, 11.8232, 8.8359, 10.973, 8.8159, 7.4944, 8.7974, 14.5718, 19.4237, 16.0455, 16.8294, 29.2216, 26.465, 21.1603, 19.1063, 13.9551, 8.3066, 5.4786, 11.4713, 31.7906, 26.0618, 18.5178, 16.1366, 14.7613, 20.2183, 19.1402, 18.5676, 18.8343, 18.5211, 16.8601, 23.6545, 21.9925, 15.4206, 12.6777, 16.9084, 12.0465, 19.3491, 18.4239, 11.3733, 6.4314, 3.2606, 2.7237, 0.8051, 5.6171, 7.849, 7.6681, 9.1071, 7.8192, 6.3474, 4.5753, 9.8178, 13.9542, 7.5524, 4.853, 6.2662, 10.5524, 6.8096, 5.2608, 6.4786, 4.5084, 4.3577, 8.5521, 11.7031, 19.3441, 21.4582, 19.8855, 12.7716, 8.2571, 5.1557, 4.4047, 5.8862, 7.7395, 11.2415, 8.1024, 5.4054, 4.8416, 5.0392, 5.45, 5.4774, 5.8948, 7.3427, 6.5695, 9.5376, 14.4096, 11.4382, 10.7148, 13.4251, 11.8031, 13.9429, 18.2878, 9.7821, 5.6693, 6.2615, 10.2089, 10.408, 6.1354, 9.2423, 8.2122, 8.781, 9.6242, 9.3052, 7.961, 7.5152, 6.6953, 5.231, 3.8402, 2.3767, 1.7936, 2.3192, 2.8756, 2.6369, 2.4585, 2.1958, 2.2909, 0.0542, 1.9956, 2.4406, 2.3791, 3.1413, 2.3434, 2.7274, 2.0718, 1.7751, 1.3768, 1.1375, 1.2239, 1.134, 0.7929, 1.1228, 0.6176, 0.8584, 0.7829, 0.8233, 2.5277, 0.7679, 0.9122, 0.6087, 1.0735, 0.0, 1.865, 1.669, 1.4415, 2.7967, 1.5385, 3.2864, 2.5786, 2.3965, 1.4207, 0.5991, 1.6087, 0.1875, 0.3336, 0.2632, 0.001, 0.2301, 0.0045, 0.0117, 0.0826, 0.135, 0.0754, 0.0, 0.0364, 0.0, 0.6535, 1.3098, 2.0641, 1.8003, 0.4803, 0.0047, 0.126, 0.0652, 0.2118, 0.004, 0.0817, 0.0019, 0.0, 0.0859, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.2629, 1.5613, 0.1383, 0.3716, 0.0, 0.0601, 0.0, 0.0516, 0.0, 0.078, 0.2598, 0.0491, 0.1716, 0.0, 0.0613, 0.0728, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0486, 2.7376, 2.9073, 1.7589, 1.9258, 1.7477, 1.3024, 0.0073, 0.0, 0.1749, 0.0613, 0.061, 0.0491, 0.0, 0.0, 0.0613, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.873, 1.9352, 0.8831, 0.7268, 0.7272, 0.6767, 0.6761, 0.3458, 0.0564, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.276, 0.4876, 2.2984, 3.342, 3.0214, 3.0328, 3.5998, 4.3341, 4.5244, 4.0077, 3.4111, 2.2111, 1.1747, 1.4784, 0.6051, 0.7085, 1.2258, 0.9986, 0.2646, 0.0, 0.5096, 0.0584, 0.0, 0.1, 0.0878, 0.0, 0.0319
        ]
      },
      chart:null,
      options:null,
      originSelect:[],//选取的源数据
      matchSelect:[],//匹配的数据
      matchID:1//匹配到的id


    }
  },
  methods:{
    ...mapMutations(['changeLoadingFlag','changeCurrentID','changeMatchID','changeOriginData','changeMatchedData','changeOriginFlood','changeMatchedFlood']),
    initChart(){
      let _this = this
      let el = document.getElementById("zoomChart")
      let chart = this.$echarts.init(el);
      let options ={
        legend: {
          data: ['流量', '降雨量'],
          left: 10
        },
        tooltip:{
          trigger:'axis',
          axisPointer:{
            type:'cross',
            animation:false,
            label:{
              backgroundColor:"#abc"
            }
          },
        },
        xAxis:{
          type:'category',
          data:this.currentChartParam.timestamp.map(function (str){
            return str.replace(' ',"\n");
          })
        },
        yAxis:[
          {
            name:"流量",
            type:'value'
          },{
            name:"降雨量",
            nameLocation:'start',
            inverse:true,
            type:'value',
            alignTicks: true,
          }
        ],
        toolbox:{
          feature:{
            dataZoom:{
              show:true,
              brush:{
                type:['lineX']
              },
              filterMode:"filter",
              yAxisIndex:true
              // xAxisIndex:0//
            }
          }
        },
        series:[
          {
            name:'流量',
            type:'line',
            lineStyle:{
              width:1,
              color:"#01b72a"
            },
            itemStyle:{
              normal:{
                color:"#3ecda0"

              }
            },
            emphasis:{
              focus:'series',
            },
            data:this.currentChartParam.flow,
          },
          {
            name: '降雨量',
            type: 'bar',
            yAxisIndex:1,
            itemStyle: {
              color:"#00a2ea"
            },
            emphasis: {
              focus: 'series'
            },
            data: this.currentChartParam.rain
          }
        ]

      };
      //监听选择
      chart.on('datazoom',function (param){

        console.log("datazoom监听到啦  ",param)
        // loading.value = true
        let startValue = param.batch[0].startValue
        let endValue = param.batch[0].endValue
        if (startValue == endValue){
          //说明是返回的情况
          // loading.value = false
          return
        }
        _this.changeLoadingFlag(true)


        console.log(startValue,endValue)
        console.log("现在选取的：",_this.currentChartParam.flow.slice(startValue,endValue))

        // setTimeout(()=>{
        //   loading.value = false
        // },2000)
        let data={}
        data['id'] = 1
        data['startValue'] = startValue
        data['endValue'] = endValue
        postRequestJson("/brush",JSON.stringify(data))
          .then((res)=>{
            console.log(res)

            let data = res.data.data;
            _this.changeMatchID(data.idResult);
            let originSelect = data.x1Shapelet;
            let matchSelect = data.x2Shapelet;
            let originFlood = data.x1Line;
            let matchedFlood = data.x2Line;

            _this.changeOriginData(str2listForRain(originSelect));
            _this.changeMatchedData(str2listForRain(matchSelect));
            // console.log(_this.matchID,_this.matchSelect,_this.originSelect)
            _this.changeMatchedFlood(str2listForRain(matchedFlood));
            _this.changeOriginFlood(str2listForRain(originFlood));


            _this.changeLoadingFlag(false)

            // loading.value = false
          })
          .catch((err)=>{
            _this.changeLoadingFlag(false)
          })

      })


      chart.setOption(options);

      //添加窗口收缩的监听，重新绘制大小。
      window.addEventListener('resize',()=>{
        chart.resize()
      })
      //添加侧边栏收缩的监听，重新绘制大小。
      const observer = new ResizeObserver(entries => {
        chart.resize()
      })
      observer.observe(el)
    }

  },
  mounted() {
    this.initChart()
  },
  watch:{

  }
}
</script>

<style scoped>
#zoomChart{
  height: calc(50vh - 96px);
}

</style>
